# 订单管理系统 - 开发计划文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2025-02-21 |
| 项目名称 | Super Order 订单管理系统 |
| 文档类型 | 开发计划文档 |

---

## 开发阶段概览

| 阶段 | 内容 | 预计工期 |
|------|------|---------|
| 第一阶段 | 基础后端文件目录 | 3天 |
| 第二阶段 | 后端开发 | 15天 |
| 第三阶段 | 前端开发 | 15天 |
| **总计** | | **33天** |

---

## 第一阶段：基础后端文件目录（3天）

### 1.1 创建 main.py 入口文件
**目标**: 创建 FastAPI 主应用入口，提供基础的 health 接口

**任务清单**:
- [ ] 初始化 FastAPI 应用
- [ ] 配置 CORS 中间件
- [ ] 实现健康检查接口 `GET /health`
- [ ] 配置日志系统
- [ ] 配置环境变量管理（.env 文件）

**交付物**:
- `backend/main.py` - FastAPI 应用入口文件
- `backend/requirements.txt` - Python 依赖包列表

**技术要点**:
```python
# main.py 示例代码结构
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(title="Super Order API")

# CORS 配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/health")
async def health_check():
    return {"status": "ok", "service": "super-order-api"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 1.2 Docker Compose 配置
**目标**: 编写 docker-compose.yml，包含后端服务、MySQL 和 MinIO

**任务清单**:
- [ ] 配置 MySQL 服务（8.0 版本）
- [ ] 配置 MinIO 服务（对象存储）
- [ ] 配置后端服务（FastAPI）
- [ ] 配置服务间网络连接
- [ ] 配置数据持久化卷
- [ ] 配置环境变量

**交付物**:
- `docker-compose.yml` - Docker 编排文件
- `docker/.env` - 环境变量配置文件
- `docker/init.sql` - 数据库初始化脚本

**技术要点**:
```yaml
# docker-compose.yml 示例结构
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: super-order-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

  minio:
    image: minio/minio
    container_name: super-order-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"

  backend:
    build: ./backend
    container_name: super-order-backend
    environment:
      DATABASE_URL: ${DATABASE_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    ports:
      - "8000:8000"
    depends_on:
      - mysql
      - minio

volumes:
  mysql-data:
  minio-data:
```

### 1.3 数据导入脚本
**目标**: 创建 scripts 文件夹下的 Python 脚本，将 doc 下的 xlsx 数据导入到 MySQL 和 MinIO

**任务清单**:
- [ ] 创建 `scripts/` 目录结构
- [ ] 开发 Excel 解析脚本（使用 openpyxl）
- [ ] 开发图片上传脚本（上传到 MinIO）
- [ ] 开发数据清洗脚本（处理字段映射）
- [ ] 开发数据库导入脚本（使用 SQLAlchemy）
- [ ] 实现整箱数量特殊处理逻辑
- [ ] 实现产品名称去重和 SKU 自动生成
- [ ] 实现数据验证和错误处理

**交付物**:
- `scripts/import_orders.py` - 订单导入主脚本
- `scripts/import_sku.py` - SKU 导入脚本
- `scripts/minio_client.py` - MinIO 操作工具类
- `scripts/config.py` - 导入配置文件

**技术要点**:
- **Excel 解析**: 使用 openpyxl 或 pandas
- **数据映射**: Excel 表头 → 数据库字段
- **图片处理**: 上传到 MinIO 并返回 URL
- **整箱数量逻辑**:
  ```python
  # 当 unit != "箱" 时，整箱数量 = quantity
  if row['单位'] != '箱':
      box_quantity = row['数量']
  else:
      box_quantity = None
  ```
- **SKU 生成规则**: 分类ID(2位) + 流水号(4位)

**重要说明**: 数据集成和后端服务是分离的，数据导入脚本独立运行，不影响后端服务。

### 1.4 验证与修复数据导入问题
**目标**: 验证数据导入结果，修复发现的问题

**任务清单**:
- [ ] 执行数据导入脚本
- [ ] 验证 MySQL 数据完整性
- [ ] 验证 MinIO 图片上传结果
- [ ] 检查 SKU 编号唯一性
- [ ] 检查订单数据关联关系
- [ ] 修复数据导入中的问题
- [ ] 记录验证结果和修复日志

**交付物**:
- 数据导入验证报告
- 问题修复记录
- 数据校验脚本（可选）

**验证要点**:
- SKU 数量与 Excel 记录数对比
- 订单明细与订单主表关联检查
- 图片 URL 可访问性验证
- 整箱数量字段逻辑验证
- 金额计算准确性验证（成本金额 = 成本单价 × 数量）

---

## 第二阶段：后端开发（15天）

### 2.1 本期功能范围确认并重新梳理数据结构和流程
**目标**: 根据 PRD v1.4 确认功能范围，梳理数据结构和业务流程

**任务清单**:
- [ ] 确认本期功能范围（SKU管理、订单管理、数据导入、报表）
- [ ] 梳理数据表关系（customer、sku_category、sku、order、order_item）
- [ ] 梳理业务流程（SKU 创建、订单录入、Excel 导入、对账单生成）
- [ ] 梳理 API 接口设计
- [ ] 确认数据模型（Pydantic Models）
- [ ] 确认数据库迁移策略（Alembic）

**交付物**:
- 数据流程图
- API 接口清单（确认版）
- 数据模型设计文档

### 2.2 后端技术栈集成和代码开发
**目标**: 集成后端技术栈，开发核心业务逻辑

**任务清单**:

#### 2.2.1 项目结构搭建（2天）
- [ ] 创建后端项目目录结构
- [ ] 配置 SQLAlchemy 数据库连接
- [ ] 配置 Pydantic 数据验证
- [ ] 配置 MinIO 客户端
- [ ] 配置 Alembic 数据库迁移
- [ ] 配置日志和异常处理

#### 2.2.2 数据模型开发（3天）
- [ ] 创建 customer 模型
- [ ] 创建 sku_category 模型
- [ ] 创建 sku 模型
- [ ] 创建 order 模型
- [ ] 创建 order_item 模型
- [ ] 创建 user 模型
- [ ] 创建 import_log 模型
- [ ] 编写 Alembic 迁移脚本

#### 2.2.3 SKU 管理模块开发（3天）
- [ ] 实现 SKU CRUD 接口
- [ ] 实现 SKU 列表查询（分页、筛选）
- [ ] 实现 SKU 模糊搜索接口（用于自动完成）
- [ ] 实现 SKU 图片上传接口（MinIO）
- [ ] 实现分类列表查询接口（固定数据）
- [ ] 实现成本单价和销售单价更新

**接口清单**:
- `GET /api/sku` - 获取 SKU 列表
- `GET /api/sku/{id}` - 获取 SKU 详情
- `POST /api/sku` - 创建 SKU
- `PUT /api/sku/{id}` - 更新 SKU
- `DELETE /api/sku/{id}` - 删除 SKU
- `GET /api/sku/search` - SKU 模糊搜索
- `POST /api/sku/{id}/image` - 上传 SKU 图片
- `GET /api/sku/category` - 获取分类列表

#### 2.2.4 订单管理模块开发（4天）
- [ ] 实现订单 CRUD 接口
- [ ] 实现订单列表查询（多条件筛选）
- [ ] 实现订单详情查询
- [ ] 实现订单状态更新
- [ ] 实现订单明细管理接口
- [ ] 实现订单金额自动计算
- [ ] 实现客户列表查询接口（固定数据）
- [ ] 实现整箱数量字段处理

**接口清单**:
- `GET /api/order` - 获取订单列表
- `GET /api/order/{id}` - 获取订单详情
- `POST /api/order` - 创建订单
- `PUT /api/order/{id}` - 更新订单
- `PATCH /api/order/{id}/status` - 更新订单状态
- `POST /api/order/{id}/items` - 添加订单明细
- `PUT /api/order/{id}/items/{item_id}` - 更新订单明细
- `DELETE /api/order/{id}/items/{item_id}` - 删除订单明细
- `GET /api/customer` - 获取客户列表

**业务逻辑**:
- 订单总金额计算：
  - total_cost_amount = Σ 订单明细.cost_amount
  - total_sale_amount = Σ 订单明细.sale_amount
  - total_profit = Σ 订单明细.profit
- 整箱数量处理：手动录入时可编辑

#### 2.2.5 数据导入模块开发（2天）
- [ ] 实现 Excel 文件上传接口
- [ ] 实现导入模板下载接口
- [ ] 实现 Excel 数据解析
- [ ] 实现产品名称去重逻辑
- [ ] 实现 SKU 自动生成（分类ID + 流水号）
- [ ] 实现数据校验和错误处理
- [ ] 实现导入结果反馈

**接口清单**:
- `POST /api/import/order` - 导入 Excel 订单
- `GET /api/import/template` - 下载导入模板

**导入逻辑**:
- 产品名称去重：使用 `product_name` + `spec` 作为唯一键
- SKU 生成：
  ```python
  # 根据分类获取当前最大流水号
  max_seq = get_max_sequence_by_category(category_id)
  new_seq = max_seq + 1
  sku_code = f"{category_id}{new_seq:04d}"
  ```
- 整箱数量：根据单位字段判断

#### 2.2.6 报表模块开发（1天）
- [ ] 实现对账单 PDF 生成接口
- [ ] 实现统计数据查询接口
- [ ] 实现中文字体支持

**接口清单**:
- `POST /api/report/statement` - 生成对账单 PDF
- `GET /api/report/statistics` - 获取统计数据

**技术选型**:
- PDF 生成：WeasyPrint（支持中文）
- 模板引擎：Jinja2

### 2.3 后端接口测试
**目标**: 对所有后端接口进行测试

**任务清单**:
- [ ] 编写单元测试（pytest）
- [ ] 编写集成测试
- [ ] 测试所有 API 接口
- [ ] 测试异常处理
- [ ] 测试数据验证逻辑
- [ ] 生成测试报告

**测试覆盖**:
- SKU 管理接口
- 订单管理接口
- 数据导入接口
- 报表接口
- 数据模型验证

---

## 第三阶段：前端开发（15天）

### 3.1 前端选型确认
**目标**: 确认前端技术栈和 UI 框架

**任务清单**:
- [ ] 确认前端框架（Vue 3）
- [ ] 确认 UI 组件库（Element Plus）
- [ ] 确认状态管理
- [ ] 确认 HTTP 客户端
- [ ] 确认构建工具
- [ ] 确认代码规范（ESLint、TypeScript）

**技术选型**:
```
前端框架：Vue 3.x
UI 组件库：Element Plus
状态管理：Pinia
路由：Vue Router
HTTP 客户端：Axios
构建工具：Vite
语言：TypeScript
```

### 3.2 前端技术栈集成与代码开发
**目标**: 搭建前端项目，开发核心功能

**任务清单**:

#### 3.2.1 项目初始化（2天）
- [ ] 创建 Vue 3 项目（Vite）
- [ ] 安装 Element Plus
- [ ] 配置 Pinia 状态管理
- [ ] 配置 Vue Router
- [ ] 配置 Axios 拦截器
- [ ] 配置 TypeScript
- [ ] 配置 ESLint 和 Prettier
- [ ] 创建项目目录结构

#### 3.2.2 布局和公共组件（2天）
- [ ] 实现主布局（侧边栏、顶部栏）
- [ ] 实现登录页面
- [ ] 实现公共组件（表格、表单、对话框）
- [ ] 实现权限控制
- [ ] 实现路由守卫

#### 3.2.3 SKU 管理模块（3天）
- [ ] 实现 SKU 列表页面
- [ ] 实现 SKU 新增/编辑表单
- [ ] 实现 SKU 图片上传组件
- [ ] 实现 SKU 分类选择（固定数据下拉）
- [ ] 实现 SKU 搜索功能

**核心功能**:
- SKU 列表展示（分页、筛选）
- SKU 新增/编辑表单
- 成本单价和销售单价输入
- 箱规字段输入
- 分类下拉选择
- 图片上传预览

#### 3.2.4 订单管理模块（4天）
- [ ] 实现订单列表页面
- [ ] 实现订单录入页面
- [ ] 实现 SKU 自动完成组件（键盘操作）
- [ ] 实现订单明细动态添加/删除
- [ ] 实现订单金额自动计算
- [ ] 实现客户选择（固定数据下拉）
- [ ] 实现订单详情页面

**核心功能**:
- **SKU 快速匹配**：
  ```vue
  <el-autocomplete
    v-model="skuForm.skuCode"
    :fetch-suggestions="querySearch"
    @select="handleSelect"
    placeholder="输入SKU编号或产品名称"
  >
  ```
- **键盘操作支持**：
  - ↑↓ 键：导航候选列表
  - Enter 键：确认选择
  - Tab 键：切换字段
  - Esc 键：关闭下拉
- 订单明细动态表格
- 客户下拉选择（FZC 方舟、SE8 SE8加拿大）
- 整箱数量字段（手工录入）
- 金额自动计算和汇总

#### 3.2.5 数据导入模块（2天）
- [ ] 实现文件上传组件
- [ ] 实现导入模板下载
- [ ] 实现数据预览页面
- [ ] 实现导入进度显示
- [ ] 实现导入结果反馈

**核心功能**:
- 拖拽或点击上传 Excel 文件
- 数据预览表格
- 导入进度条
- 成功/失败统计展示
- 错误详情列表

#### 3.2.6 报表模块（2天）
- [ ] 实现对账单生成页面
- [ ] 实现客户选择和日期范围选择
- [ ] 实现 PDF 预览
- [ ] 实现 PDF 下载功能
- [ ] 实现统计数据页面

**核心功能**:
- 客户下拉选择
- 日期范围选择器
- 对账单预览
- PDF 下载
- 销售额统计图表
- 收支统计图表

### 3.3 集成测试
**目标**: 前后端集成测试

**任务清单**:
- [ ] 前后端接口联调
- [ ] 功能完整性测试
- [ ] 键盘操作体验测试
- [ ] Excel 导入测试
- [ ] PDF 生成测试
- [ ] 浏览器兼容性测试
- [ ] 性能测试
- [ ] Bug 修复
- [ ] 用户验收测试

**测试重点**:
- SKU 自动完成键盘操作流畅性
- 订单金额计算准确性
- Excel 导入数据完整性
- PDF 对账单格式正确性
- 整箱数量字段处理逻辑

---

## 交付物清单

### 第一阶段交付物
- [ ] `backend/main.py` - FastAPI 入口文件
- [ ] `docker-compose.yml` - Docker 编排文件
- [ ] `scripts/` - 数据导入脚本目录
  - [ ] `import_orders.py`
  - [ ] `import_sku.py`
  - [ ] `minio_client.py`
- [ ] 数据导入验证报告

### 第二阶段交付物
- [ ] 完整的后端 API 代码
- [ ] 数据库迁移脚本
- [ ] 单元测试和测试报告
- [ ] API 文档（自动生成 Swagger）
- [ ] 后端代码规范文档

### 第三阶段交付物
- [ ] 完整的前端应用代码
- [ ] 构建配置文件
- [ ] 集成测试报告
- [ ] 用户操作手册
- [ ] 部署文档

---

## 技术风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Excel 数据格式复杂 | 导入失败率高 | 提供标准模板，加强数据校验 |
| MinIO 配置复杂 | 图片上传失败 | 使用 Docker 简化部署，提供详细文档 |
| SKU 编号冲突 | 数据唯一性问题 | 实现流水号锁机制，添加冲突检测 |
| 键盘操作体验 | 用户不习惯 | 提供操作指引，保留鼠标操作方式 |
| PDF 中文乱码 | 对账单无法使用 | 使用 WeasyPrint，测试中文字体 |
| 前后端接口对接 | 联调问题 | 提前定义接口文档，使用 Mock 数据开发 |

---

## 里程碑节点

| 里程碑 | 完成标志 | 预计时间 |
|-------|---------|---------|
| M1: 基础环境搭建完成 | Docker 环境启动成功，health 接口正常 | 第3天 |
| M2: 数据导入完成 | Excel 数据成功导入 MySQL 和 MinIO | 第3天 |
| M3: 后端 API 开发完成 | 所有 API 接口开发完成并通过测试 | 第18天 |
| M4: 前端页面开发完成 | 所有功能页面开发完成 | 第33天 |
| M5: 集成测试通过 | 前后端联调成功，功能验收通过 | 第33天 |

---

## 附录

### A. 项目目录结构（最终版）

```
super-order/
├── backend/                  # 后端项目
│   ├── main.py             # FastAPI 入口
│   ├── app/
│   │   ├── api/            # API 路由
│   │   ├── models/         # SQLAlchemy 模型
│   │   ├── schemas/        # Pydantic 模型
│   │   ├── services/       # 业务逻辑
│   │   ├── core/           # 核心配置
│   │   │   ├── config.py
│   │   │   ├── security.py
│   │   │   └── database.py
│   │   └── utils/          # 工具函数
│   ├── alembic/            # 数据库迁移
│   ├── tests/              # 测试文件
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/                 # 前端项目
│   ├── src/
│   │   ├── api/            # API 接口
│   │   ├── components/     # 公共组件
│   │   ├── views/          # 页面视图
│   │   ├── stores/         # Pinia 状态
│   │   ├── router/         # 路由配置
│   │   ├── utils/          # 工具函数
│   │   └── types/          # TypeScript 类型
│   ├── package.json
│   └── vite.config.ts
├── scripts/                  # 数据导入脚本
│   ├── import_orders.py
│   ├── import_sku.py
│   ├── minio_client.py
│   └── config.py
├── docker/                   # Docker 配置
│   ├── docker-compose.yml
│   └── .env
├── doc/                     # 文档和 Excel 文件
│   ├── 方舟产品订单表（原始记录不外发）251117.xlsx
│   └── 方舟产品订单表（原始记录不外发）260112.xlsx
├── PRD.md                   # 产品需求文档
├── 开发计划.md               # 开发计划文档
└── README.md                # 项目说明
```

### B. 数据导入流程

```
1. 启动 Docker 环境
   ↓
2. 执行数据导入脚本
   scripts/import_orders.py
   ↓
3. 解析 Excel 文件
   ↓
4. 上传图片到 MinIO
   ↓
5. 生成 SKU 编号
   ↓
6. 导入数据到 MySQL
   ↓
7. 验证数据完整性
   ↓
8. 启动后端服务
   ↓
9. 前端访问 API
```

### C. 关键技术决策

| 技术点 | 选择方案 | 理由 |
|-------|---------|------|
| 后端框架 | FastAPI | 高性能、自动 API 文档、类型提示 |
| ORM | SQLAlchemy | 成熟稳定、迁移支持好 |
| 数据验证 | Pydantic v2 | 类型安全、与 FastAPI 深度集成 |
| 对象存储 | MinIO | 兼容 S3 API、Docker 支持好 |
| 前端框架 | Vue 3 | 学习曲线平缓、生态完善 |
| UI 组件库 | Element Plus | 组件丰富、中文文档完善 |
| PDF 生成 | WeasyPrint | 支持中文、模板灵活 |
| 数据导入脚本 | 独立运行 | 与后端服务解耦、便于调试 |

---

**文档结束**
